# gpool æ€§èƒ½åˆ†ææŠ¥å‘Š

## å½“å‰åŸºå‡†æµ‹è¯•ç»“æœ
- å¹³å‡æ“ä½œå»¶è¿Ÿ: ~6000 ns/op
- å†…å­˜åˆ†é…: ~2200 B/op
- åˆ†é…æ¬¡æ•°: ~28 allocs/op

## å‘ç°çš„æ€§èƒ½é—®é¢˜

### 1. ğŸ”´ ä¸¥é‡ï¼šSubmit() ä¸­çš„å…¨å±€é”ç«äº‰ (ç¬¬271-272è¡Œ)
**é—®é¢˜ï¼š**
```go
func (s *Pool) Submit(job func()) error {
    s.submitLock.Lock()        // å…¨å±€é”ï¼Œæ‰€æœ‰æäº¤éƒ½ä¼šç«äº‰
    defer s.submitLock.Unlock()
    ...
}
```
**å½±å“ï¼š** 
- åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œæ‰€æœ‰goroutineéƒ½åœ¨ç«äº‰è¿™ä¸€ä¸ªé”
- ä¸¥é‡é™åˆ¶äº†ååé‡ï¼Œæ— æ³•å……åˆ†åˆ©ç”¨å¤šæ ¸CPU

**ä¼˜åŒ–å»ºè®®ï¼š**
- ä½¿ç”¨æ— é”é˜Ÿåˆ— (lock-free queue)
- æˆ–è€…ä½¿ç”¨åˆ†æ®µé”ç­–ç•¥
- æˆ–è€…ä½¿ç”¨channelæ¥ä»£æ›¿mutex+list

---

### 2. ğŸŸ¡ ä¸­ç­‰ï¼šnotifyAll() éå†æ‰€æœ‰worker (ç¬¬303-310è¡Œ)
**é—®é¢˜ï¼š**
```go
func (s *Pool) notifyAll() {
    s.workers.RangeFast(func(_, v interface{}) bool {
        if v.(*worker).Status() == statusIdle {
            v.(*worker).Wakeup()
        }
        return true
    })
}
```
**å½±å“ï¼š**
- æ¯æ¬¡æäº¤ä»»åŠ¡éƒ½è¦éå†æ‰€æœ‰worker
- å½“workeræ•°é‡å¾ˆå¤§æ—¶ï¼ˆå¦‚50000ï¼‰ï¼Œæ€§èƒ½ä¸‹é™æ˜æ˜¾

**ä¼˜åŒ–å»ºè®®ï¼š**
- ç»´æŠ¤ä¸€ä¸ªç©ºé—²workeré˜Ÿåˆ—/channel
- åªå”¤é†’ä¸€ä¸ªç©ºé—²workerè€Œä¸æ˜¯éå†æ‰€æœ‰
- ä½¿ç”¨æ¡ä»¶å˜é‡æ›¿ä»£ä¸»åŠ¨å”¤é†’

---

### 3. ğŸŸ¡ ä¸­ç­‰ï¼šdebug.Stack() çš„é«˜æ˜‚å¼€é”€ (ç¬¬288-295è¡Œ)
**é—®é¢˜ï¼š**
```go
if s.opt.WithStack {
    a := bytes.SplitN(debug.Stack(), []byte("\n"), 4)
    stackStr := string(a[0])
    if len(a) > 3 {
        stackStr += "\n" + string(a[3])
    }
    j.Stack = stackStr
}
```
**å½±å“ï¼š**
- debug.Stack() æ˜¯ä¸€ä¸ªæ˜‚è´µçš„æ“ä½œ
- é»˜è®¤å¼€å¯ï¼ˆWithStack: trueï¼‰ï¼Œæ¯æ¬¡Submitéƒ½ä¼šè°ƒç”¨
- å³ä½¿ä¸éœ€è¦stack traceä¹Ÿä¼šäº§ç”Ÿå¼€é”€

**ä¼˜åŒ–å»ºè®®ï¼š**
- é»˜è®¤å…³é—­WithStack
- æˆ–è€…ä»…åœ¨panicæ—¶æ‰è·å–stack
- è€ƒè™‘ä½¿ç”¨runtime.Caller()æ›¿ä»£debug.Stack()

---

### 4. ğŸŸ¡ ä¸­ç­‰ï¼šworker IDç”Ÿæˆä½¿ç”¨crypto/rand (ç¬¬237-243è¡Œ)
**é—®é¢˜ï¼š**
```go
func (s *Pool) newWorkerID() string {
    k := make([]byte, 16)
    if _, err := io.ReadFull(rand.Reader, k); err != nil {
        return ""
    }
    return hex.EncodeToString(k)
}
```
**å½±å“ï¼š**
- crypto/rand æ¯” math/rand æ…¢å¾ˆå¤š
- æ¯ä¸ªworkeråˆ›å»ºæ—¶éƒ½è¦ç”ŸæˆID
- å¯¹äºgoroutine poolæ¥è¯´ï¼Œä¸éœ€è¦å¯†ç å­¦çº§åˆ«çš„éšæœºæ€§

**ä¼˜åŒ–å»ºè®®ï¼š**
- ä½¿ç”¨atomic counterç”Ÿæˆé€’å¢ID
- æˆ–è€…ä½¿ç”¨math/rand
- IDåªç”¨äºè°ƒè¯•ï¼Œä¸éœ€è¦å…¨å±€å”¯ä¸€æ€§

---

### 5. ğŸŸ¢ è½»å¾®ï¼šworkerçŠ¶æ€æ£€æŸ¥ä½¿ç”¨æ™®é€šå˜é‡ (ç¬¬378-380è¡Œ)
**é—®é¢˜ï¼š**
```go
func (w *worker) Status() int {
    return w.status
}
```
**å½±å“ï¼š**
- statusæ˜¯æ™®é€šintå˜é‡ï¼Œæ²¡æœ‰ä½¿ç”¨atomicæ“ä½œ
- åœ¨å¹¶å‘ç¯å¢ƒä¸‹å¯èƒ½å­˜åœ¨data race
- è™½ç„¶å½±å“è¾ƒå°ï¼Œä½†ä¸å¤Ÿå®‰å…¨

**ä¼˜åŒ–å»ºè®®ï¼š**
- ä½¿ç”¨atomic.LoadInt32/StoreInt32
- ç¡®ä¿å¹¶å‘å®‰å…¨

---

### 6. ğŸŸ¢ è½»å¾®ï¼šworkerè®¡æ•°å™¨çš„è´Ÿæ•°æ£€æŸ¥å¼€é”€ (ç¬¬391-401è¡Œ)
**é—®é¢˜ï¼š**
```go
func (w *worker) addWorkerCounter(cnt *int64, val int64) {
    if val < 0 {
        if atomic.LoadInt64(cnt)-val >= 0 {  // é¢å¤–çš„LoadInt64è°ƒç”¨
            atomic.AddInt64(cnt, val)
        } else {
            atomic.AddInt64(cnt, 0)
        }
    } else {
        atomic.AddInt64(cnt, val)
    }
}
```
**å½±å“ï¼š**
- å‡å°‘è®¡æ•°æ—¶éœ€è¦é¢å¤–çš„LoadInt64æ“ä½œ
- å¢åŠ äº†åŸå­æ“ä½œçš„æ¬¡æ•°

**ä¼˜åŒ–å»ºè®®ï¼š**
- ç›´æ¥ä½¿ç”¨AddInt64ï¼Œè®©å®ƒè¿”å›è´Ÿæ•°ç„¶åæ£€æŸ¥
- æˆ–è€…ä¿¡ä»»è°ƒç”¨è€…ï¼Œä¸åšè´Ÿæ•°æ£€æŸ¥

---

### 7. ğŸŸ¢ è½»å¾®ï¼šjobsä½¿ç”¨glist.Listè€Œéchannel (ç¬¬38è¡Œ)
**é—®é¢˜ï¼š**
```go
jobs *glist.List
```
**å½±å“ï¼š**
- Listéœ€è¦é…åˆmutexä½¿ç”¨
- channelæœ‰æ›´å¥½çš„å¹¶å‘æ€§èƒ½å’Œè¯­ä¹‰

**ä¼˜åŒ–å»ºè®®ï¼š**
- è€ƒè™‘ä½¿ç”¨buffered channelæ›¿ä»£List+Mutex
- Goçš„channelåœ¨goroutineè°ƒåº¦æ–¹é¢æœ‰ç‰¹æ®Šä¼˜åŒ–

---

## æ€§èƒ½ä¼˜åŒ–å»ºè®®ä¼˜å…ˆçº§

### P0 - é«˜ä¼˜å…ˆçº§
1. **ç§»é™¤Submit()ä¸­çš„å…¨å±€é”**
   - é¢„æœŸæå‡ï¼š2-5xååé‡
   - å®ç°éš¾åº¦ï¼šä¸­ç­‰
   
2. **ä¼˜åŒ–notifyAllæœºåˆ¶**
   - é¢„æœŸæå‡ï¼š10-50%ï¼ˆworkeræ•°é‡è¶Šå¤šæå‡è¶Šå¤§ï¼‰
   - å®ç°éš¾åº¦ï¼šä¸­ç­‰

### P1 - ä¸­ä¼˜å…ˆçº§
3. **é»˜è®¤å…³é—­WithStackæˆ–å»¶è¿Ÿè·å–**
   - é¢„æœŸæå‡ï¼š20-30%
   - å®ç°éš¾åº¦ï¼šç®€å•

4. **ä¼˜åŒ–worker IDç”Ÿæˆ**
   - é¢„æœŸæå‡ï¼šåœ¨é¢‘ç¹åˆ›å»ºworkeræ—¶æœ‰5-10%æå‡
   - å®ç°éš¾åº¦ï¼šç®€å•

### P2 - ä½ä¼˜å…ˆçº§
5. **ä½¿ç”¨atomicä¿æŠ¤worker status**
   - é¢„æœŸæå‡ï¼šcorrectnessä¿®å¤ï¼Œæ€§èƒ½å½±å“å¾®å°
   - å®ç°éš¾åº¦ï¼šç®€å•

6. **ç®€åŒ–counteræ“ä½œ**
   - é¢„æœŸæå‡ï¼š<5%
   - å®ç°éš¾åº¦ï¼šç®€å•

## æ¨èçš„ä¼˜åŒ–æ¶æ„

### é€‰é¡¹Aï¼šæ— é”é˜Ÿåˆ—æ¶æ„
```go
type Pool struct {
    jobQueue     chan func()           // ä½¿ç”¨channelæ›¿ä»£List+Mutex
    workers      []*worker              // ç®€å•slice
    idleWorkers  chan *worker           // ç©ºé—²workeré˜Ÿåˆ—
    // ...
}
```

### é€‰é¡¹Bï¼šåˆ†æ®µé”æ¶æ„
```go
type Pool struct {
    segments     []*poolSegment         // å¤šä¸ªsegmentå‡å°‘ç«äº‰
    // ...
}

type poolSegment struct {
    lock    sync.Mutex
    jobs    *glist.List
    workers *gmap.Map
}
```

### é€‰é¡¹Cï¼šWork-Stealingæ¶æ„
ç±»ä¼¼Go runtimeçš„è°ƒåº¦å™¨ï¼Œæ¯ä¸ªworkeræœ‰è‡ªå·±çš„æœ¬åœ°é˜Ÿåˆ—ï¼Œç©ºé—²æ—¶ä»å…¶ä»–workerå·å–ä»»åŠ¡ã€‚

## æµ‹è¯•å»ºè®®
1. æ·»åŠ å¹¶å‘Submitçš„åŸºå‡†æµ‹è¯•
2. æ·»åŠ ä¸åŒworker/jobæ¯”ä¾‹çš„æµ‹è¯•åœºæ™¯
3. ä½¿ç”¨race detectoræ£€æŸ¥å¹¶å‘å®‰å…¨æ€§
4. ä½¿ç”¨pprofåˆ†æCPUå’Œå†…å­˜çƒ­ç‚¹

## æ€»ç»“
å½“å‰å®ç°æ˜¯ç»å…¸çš„é”+é˜Ÿåˆ—æ¨¡å¼ï¼Œåœ¨ä½å¹¶å‘åœºæ™¯ä¸‹è¡¨ç°è‰¯å¥½ï¼Œä½†åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹å­˜åœ¨æ˜æ˜¾çš„é”ç«äº‰é—®é¢˜ã€‚å»ºè®®ä¼˜å…ˆè§£å†³Submit()çš„å…¨å±€é”å’ŒnotifyAll()çš„éå†å¼€é”€ï¼Œè¿™ä¸¤ä¸ªä¼˜åŒ–èƒ½å¸¦æ¥æœ€æ˜¾è‘—çš„æ€§èƒ½æå‡ã€‚
